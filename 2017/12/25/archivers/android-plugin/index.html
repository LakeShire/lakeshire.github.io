<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=PT Mono:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android,插件化," />





  <link rel="alternate" href="/atom.xml" title="湖畔镇" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="插件化背景应用功能越来越多，代码膨胀，触及65535方法数的上限，应用体积太大 实时更新独立模块的需求越来越强 功能模块的解耦，方便维护 H5和Hybrid可以解决一些问题，但是体验比不上Native代码，因此插件化有其必要性 代理代理可以用来进行方法增强或拦截 静态代理123456789101112131415161">
<meta name="keywords" content="Android,插件化">
<meta property="og:type" content="article">
<meta property="og:title" content="Android插件化">
<meta property="og:url" content="http://lakeshire.github.io/2017/12/25//archivers/android-plugin/index.html">
<meta property="og:site_name" content="湖畔镇">
<meta property="og:description" content="插件化背景应用功能越来越多，代码膨胀，触及65535方法数的上限，应用体积太大 实时更新独立模块的需求越来越强 功能模块的解耦，方便维护 H5和Hybrid可以解决一些问题，但是体验比不上Native代码，因此插件化有其必要性 代理代理可以用来进行方法增强或拦截 静态代理12345678910111213141516171819202122interface IAct &amp;#123;    voi">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-12-26T03:04:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android插件化">
<meta name="twitter:description" content="插件化背景应用功能越来越多，代码膨胀，触及65535方法数的上限，应用体积太大 实时更新独立模块的需求越来越强 功能模块的解耦，方便维护 H5和Hybrid可以解决一些问题，但是体验比不上Native代码，因此插件化有其必要性 代理代理可以用来进行方法增强或拦截 静态代理12345678910111213141516171819202122interface IAct &amp;#123;    voi">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://lakeshire.github.io/2017/12/25//archivers/android-plugin/"/>





  <title> Android插件化 | 湖畔镇 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta custom-logo">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">湖畔镇</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description"></h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lakeshire.github.io/2017/12/25/archivers/android-plugin/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="刘晗">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="湖畔镇">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="湖畔镇" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                Android插件化
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-25T17:00:00+08:00">
                2017-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          
 
        


        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <a id="more"></a>
<h1 id="插件化"><a href="#插件化" class="headerlink" title="插件化"></a>插件化</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>应用功能越来越多，代码膨胀，触及65535方法数的上限，应用体积太大</p>
<p>实时更新独立模块的需求越来越强</p>
<p>功能模块的解耦，方便维护</p>
<p>H5和Hybrid可以解决一些问题，但是体验比不上Native代码，因此插件化有其必要性</p>
<h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><p>代理可以用来进行方法增强或拦截</p>
<h3 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IAct</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">act</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Agent</span> <span class="keyword">implements</span> <span class="title">IAct</span> </span>&#123;</span><br><span class="line">    IAct base;</span><br><span class="line">  </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Agent</span>(<span class="title">IActor</span> <span class="title">agent</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.base = agent;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">act</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 干点啥</span></span><br><span class="line">        base.act();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Actor</span> <span class="keyword">implements</span> <span class="title">IAct</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">book</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p>传统的静态代理模式需要为每一个需要代理的类写一个代理类，比较麻烦，为了更优雅地实现代理模式，JDK提供了动态代理方式，可以简单理解为JVM可以在运行时帮我们动态生成一系列的代理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IAct impl = <span class="keyword">new</span> Actor();</span><br><span class="line">IAct proxy = (IAct) Proxy.newProxyInstance(IAct.class.getClassLoader(), <span class="keyword">new</span> Class[] &#123; IAct.class &#125;, <span class="keyword">new</span> ActHandler(impl));</span><br></pre></td></tr></table></figure>
<p>动态代理主要处理<code>InvocationHandler</code>和<code>Proxy</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    IAct base;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActHandler</span><span class="params">(ActImpl impl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.base = impl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 干点啥</span></span><br><span class="line">        <span class="keyword">return</span> method.invoke(base);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h2><p>通过创建代理对象替代原始对象，进行功能增强，称为Hook，以<code>startActivity()</code>为例</p>
<p>找到被Hook的对象，称为Hook点，静态变量和单例比较适合，因为相对不容易变化</p>
<p><code>Context.startActivity()</code>实际调用了<code>ActivityThread</code>类的<code>mInstrumentation</code>的<code>execStartActivity()</code> 方法，<code>ActivityThread</code>是主线程，一个程序只有一个，因此是个良好的Hook点</p>
<p>把<code>mInstrumentation</code>替换成代理对象，首先需要获得主线程对象，可以通过<code>ActivityThread.currentActivityThread()</code>获得，<code>ActivityThread</code>是一个隐藏类，需要反射获取</p>
<p><em>HookInstrumentation.java</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HookInstrumentation</span> <span class="keyword">extends</span> <span class="title">Instrumentation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Instrumentation mBase;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HookInstrumentation</span><span class="params">(Instrumentation base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mBase = base;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(Context who, IBinder contextThread, IBinder token, Activity target, Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">        intent.setComponent(<span class="keyword">new</span> ComponentName(MyApplication.APP, HookActivity.class));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method method = Instrumentation.class.getDeclaredMethod(<span class="string">"execStartActivity"</span>, Context.class, IBinder.class, IBinder.class, Activity.class, Intent.class, <span class="keyword">int</span>.class, Bundle.class);</span><br><span class="line">            method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> (ActivityResult) method.invoke(mBase, who, contextThread, token, target, intent, requestCode, options);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们加了一句打印，并把目标换成了<code>HookActivity</code>，反射获取<code>Instrumentation</code>类的<code>execStartActivity()</code>方法并调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   	Class&lt;?&gt; clazz = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">   	Method method = clazz.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">   	method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">   	Object currentActivityThread = method.invoke(<span class="keyword">null</span>);</span><br><span class="line">   	Field instrumentationField = currentActivityThread.getClass().getDeclaredField(<span class="string">"mInstrumentation"</span>);</span><br><span class="line">   	instrumentationField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">   	Instrumentation instrumentation = (Instrumentation) instrumentationField.get(currentActivityThread);</span><br><span class="line">   	HookInstrumentation hookInstrumentation = <span class="keyword">new</span> HookInstrumentation(instrumentation);</span><br><span class="line">   	instrumentationField.set(currentActivityThread, hookInstrumentation);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">   	e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">   	e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">   	e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">   	e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">   	e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获得<code>ActivityThread</code>类，找到<code>currentActivityThread()</code>方法，调用方法获得<code>ActivityThread</code>对象，然后找到<code>mInstrumentation</code>字段，获取对象，用代理对象替代并设置进去，就完成了Hook</p>
<h2 id="Binder-Hook"><a href="#Binder-Hook" class="headerlink" title="Binder Hook"></a>Binder Hook</h2><p>Hook系统服务的机制称之为Binder Hook，因为本质上这些服务提供者都是存在于系统各个进程的Binder对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取原始的IBinder对象</span></span><br><span class="line">IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</span><br><span class="line"><span class="comment">// 转换为Service</span></span><br><span class="line">IActivityManager in = asInterface(b);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> android.content.<span class="function">IClipboard <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">    <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> android.content.IClipboard))) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((android.content.IClipboard) iin);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> android.content.IClipboard.Stub.Proxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以通过修改<code>queryLocalInterface()</code>来替换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title">getService</span><span class="params">(String name)</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">try</span> &#123;        </span><br><span class="line">        IBinder service = sCache.get(name);        </span><br><span class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;            </span><br><span class="line">            <span class="keyword">return</span> service;        </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;            </span><br><span class="line">            <span class="keyword">return</span> getIServiceManager().getService(name);        </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;        </span><br><span class="line">        Log.e(TAG, <span class="string">"error in getService"</span>, e);    </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderHookHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object mBase;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BinderHookHandler</span><span class="params">(IBinder base, Class&lt;?&gt; stubClass)</span> </span>&#123;</span><br><span class="line">        Method method = stubClass.getDeclaredMethod(<span class="string">"asInterface"</span>, IBinder.class);</span><br><span class="line">        <span class="keyword">this</span>.mBase = method.invoke(<span class="keyword">null</span>, base);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">"getPrimaryClip"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ClipData.newPlainText(<span class="keyword">null</span>,<span class="string">"你被黑了"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.getName().equals(<span class="string">"hasPrimaryClip"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(mBase, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>剪贴板接口<code>IClipboard</code>的动态代理，替换了<code>getPrimaryClip()</code>和<code>hasPrimaryClip()</code>两个方法，构造方法中调用<code>Clipboard$Stub</code>的<code>asInterface()</code>方法，把传入的<code>IBinder</code>转为<code>IClipboard</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderProxyHookHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; mIInterface;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; mStub;</span><br><span class="line">    <span class="keyword">private</span> IBinder mBase;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BinderProxyHookHandler</span><span class="params">(IBinder base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mBase = base;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.mStub = Class.forName(<span class="string">"android.content.IClipboard$Stub"</span>);</span><br><span class="line">            <span class="keyword">this</span>.mIInterface = Class.forName(<span class="string">"android.content.IClipboard"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">"queryLocalInterface"</span>)) &#123;</span><br><span class="line">            <span class="comment">// 第二个参数表示代理类需要实现的接口</span></span><br><span class="line">            <span class="keyword">return</span> Proxy.newProxyInstance(proxy.getClass().getClassLoader(), <span class="keyword">new</span> Class[]&#123;IBinder.class, IInterface.class, <span class="keyword">this</span>.mIInterface&#125;, <span class="keyword">new</span> BinderHookHandler(mBase, mStub));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(mBase, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理替换<code>IBinder</code>，修改其<code>queryLocalInterface()</code>方法，使其返回Hook后的剪贴板管理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得ServiceManager类 从中获得getService方法</span></span><br><span class="line">Class&lt;?&gt; serviceManager = Class.forName(<span class="string">"android.os.ServiceManager"</span>);</span><br><span class="line">Method getService = serviceManager.getDeclaredMethod(<span class="string">"getService"</span>, String.class);</span><br><span class="line">   </span><br><span class="line"><span class="comment">// 调用getService方法 获得剪贴板服务的IBinder Hook之改写其queryLocalInterface()方法 使其返回一个实际被重写的剪贴板服务</span></span><br><span class="line">IBinder rawBinder = (IBinder) getService.invoke(<span class="keyword">null</span>, <span class="string">"clipboard"</span>);</span><br><span class="line"> IBinder hookBinder = (IBinder) Proxy.newProxyInstance(serviceManager.getClassLoader(), <span class="keyword">new</span> Class[] &#123; IBinder.class &#125;, <span class="keyword">new</span> BinderProxyHookHandler(rawBinder));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得sCache字段 往里面填入Hook过的剪贴板IBinder</span></span><br><span class="line"> Field cacheField = serviceManager.getDeclaredField(<span class="string">"sCache"</span>);</span><br><span class="line"> cacheField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"> Map&lt;String, IBinder&gt; cache = (Map&lt;String, IBinder&gt;) cacheField.get(<span class="keyword">null</span>);</span><br><span class="line"> cache.put(<span class="string">"clipboard"</span>, hookBinder);</span><br></pre></td></tr></table></figure>
<h3 id="AMS"><a href="#AMS" class="headerlink" title="AMS"></a>AMS</h3><p><code>ActivityManagerNative</code>实际上是<code>ActivityManagerService</code>这个远程对象的Binder代理对象，因为比较常用，所以有一个<code>gDefault</code>的全局变量保存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得ActivityManagerNative 获得其gDefault字段</span></span><br><span class="line">Class&lt;?&gt; activityManagerNative = Class.forName(<span class="string">"android.app.ActivityManagerNative"</span>);</span><br><span class="line"> Field gDefaultField = activityManagerNative.getDeclaredField(<span class="string">"gDefault"</span>);</span><br><span class="line"> gDefaultField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"> Object gDefault = gDefaultField.get(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// gDefault是一个Sigleton 获得其mInstance字段</span></span><br><span class="line"> Class&lt;?&gt; singleton = Class.forName(<span class="string">"android.util.Singleton"</span>);</span><br><span class="line"> Field mInstanceField = singleton.getDeclaredField(<span class="string">"mInstance"</span>);</span><br><span class="line"> mInstanceField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得ActivityManagerProxy</span></span><br><span class="line"><span class="comment">// 代理Hook掉并设置回去</span></span><br><span class="line"> Object rawActivityManager = mInstanceField.get(gDefault);</span><br><span class="line"> Class&lt;?&gt; iActivityManagerInterface = Class.forName(<span class="string">"android.app.IActivityManager"</span>);</span><br><span class="line"> Object proxy = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), <span class="keyword">new</span> Class[]&#123; iActivityManagerInterface &#125;, <span class="keyword">new</span> ActivityManagerHandler(rawActivityManager));</span><br><span class="line"> mInstanceField.set(gDefault, proxy);</span><br></pre></td></tr></table></figure>
<h3 id="PMS"><a href="#PMS" class="headerlink" title="PMS"></a>PMS</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageManager <span class="title">getPackageManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPackageManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mPackageManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IPackageManager pm = ActivityThread.getPackageManager();</span><br><span class="line">    <span class="keyword">if</span> (pm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (mPackageManager = <span class="keyword">new</span> ApplicationPackageManager(<span class="keyword">this</span>, pm));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见由<code>Activity.getPackageManager()</code>获得，并经由<code>ApplicationPackagemanager</code> 包装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IPackageManager <span class="title">getPackageManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sPackageManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sPackageManager;</span><br><span class="line">    &#125;</span><br><span class="line">    IBinder b = ServiceManager.getService(<span class="string">"package"</span>);</span><br><span class="line">    sPackageManager = IPackageManager.Stub.asInterface(b);</span><br><span class="line">    <span class="keyword">return</span> sPackageManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见可以Hook掉这个静态对象<code>sPackageManager</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">Method currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">Object currentActivityThread = currentActivityThreadMethod.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">Field sPackageManagerField = activityThreadClass.getDeclaredField(<span class="string">"sPackageManager"</span>);</span><br><span class="line">sPackageManagerField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Object sPackageManager = sPackageManagerField.get(currentActivityThread);</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; iPackageManagerInterface = 	Class.forName(<span class="string">"android.content.pm.IPackageManager"</span>);</span><br><span class="line">Object proxy = Proxy.newProxyInstance(iPackageManagerInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; iPackageManagerInterface &#125;, <span class="keyword">new</span> 	PackageManagerHandler(sPackageManager));</span><br><span class="line"> sPackageManagerField.set(currentActivityThread, proxy);</span><br></pre></td></tr></table></figure>
<p>使用同样的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object mBase;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageManagerHandler</span><span class="params">(Object base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mBase = base;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">"getPackageInfo"</span>)) &#123;</span><br><span class="line">            PackageInfo info = (PackageInfo) method.invoke(mBase, args);</span><br><span class="line">            info.packageName = <span class="string">"hook"</span>;</span><br><span class="line">            <span class="keyword">return</span> info;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.getName().equals(<span class="string">"getInstalledApplications"</span>)) &#123;</span><br><span class="line">            Object result = method.invoke(mBase, args);</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; parceledListSliceClass = Class.forName(<span class="string">"android.content.pm.ParceledListSlice"</span>);</span><br><span class="line">            Field mListField = parceledListSliceClass.getDeclaredField(<span class="string">"mList"</span>);</span><br><span class="line"></span><br><span class="line">            mListField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            List mList = (List) mListField.get(result);</span><br><span class="line"></span><br><span class="line">            List&lt;ApplicationInfo&gt; apps = (List&lt;ApplicationInfo&gt;) mList;</span><br><span class="line">            <span class="keyword">for</span> (ApplicationInfo info : apps) &#123;</span><br><span class="line">                info.packageName += <span class="string">".hook"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(mBase, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hook掉了<code>getPackageInfo()</code>方法，修改了包名，Hook掉<code>getInstalledApplications()</code>方法，在每个包名后面加了<code>.hook</code></p>
<h3 id="Activity生命周期管理"><a href="#Activity生命周期管理" class="headerlink" title="Activity生命周期管理"></a>Activity生命周期管理</h3><p>Activity必须在清单中显示声明，而清单不可能预先声明插件中的Activity</p>
<p>解决：可以预先注册一个中间Activity欺骗系统，然后替换成真正的Activity</p>
<p>首先处理ActivityManagerNative</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object mBase;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerHandler</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mBase = object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">"startActivity"</span>)) &#123;</span><br><span class="line">            <span class="comment">// 拿到Intent参数</span></span><br><span class="line">          	Intent rawIntent;</span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (args[i] <span class="keyword">instanceof</span> Intent) &#123;</span><br><span class="line">                    index = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            rawIntent = (Intent) args[index];</span><br><span class="line"></span><br><span class="line">          	<span class="comment">// 伪装一个Intent 目标Activity设置为StubActivity</span></span><br><span class="line">            Intent hookIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">            ComponentName componentName = <span class="keyword">new</span> ComponentName(MyApplication.APP, StubActivity.class.getCanonicalName());</span><br><span class="line">            hookIntent.setComponent(componentName);</span><br><span class="line">          	<span class="comment">// 把真正的Intent保存下来</span></span><br><span class="line">            hookIntent.putExtra(Constants.EXTRA_TARGET_INTENT, rawIntent);</span><br><span class="line">            args[index] = hookIntent;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(mBase, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(mBase, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样AMS侧就会认为启动了一个清单中注册的Activity，接下来在AMS对应用的回调里替换实际的Activity，所有的操作会在<code>ActivityThread.H</code>里分发处理，因为<code>Handler</code>的处理顺序是先<code>Message.handleMessage()</code>，再使用全局<code>mCallback</code>的<code>handleMessage()</code>，最后调用<code>Handler.handleMessage()</code>，所以可以Hook这个全局<code>mCallback</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HookHandlerCallback</span> <span class="keyword">implements</span> <span class="title">Handler</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; mActivityClientRecordClass;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> LAUNCH_ACTIVITY;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HookHandlerCallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      	<span class="comment">// 先反射拿到需要的类和变量</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; HClass = Class.forName(<span class="string">"android.app.ActivityThread$H"</span>);</span><br><span class="line">            Field LAUNCH_ACTIVITY_FIELD = HClass.getDeclaredField(<span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">            LAUNCH_ACTIVITY_FIELD.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            LAUNCH_ACTIVITY = (<span class="keyword">int</span>) LAUNCH_ACTIVITY_FIELD.get(<span class="keyword">null</span>);</span><br><span class="line">            mActivityClientRecordClass = Class.forName(<span class="string">"android.app.ActivityThread$ActivityClientRecord"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.what == LAUNCH_ACTIVITY) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              	<span class="comment">// 拿到ActivityClientRecord的intent字段 获得intent</span></span><br><span class="line">                Field intentField = mActivityClientRecordClass.getDeclaredField(<span class="string">"intent"</span>);</span><br><span class="line">                intentField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Intent intent = (Intent) intentField.get(msg.obj);</span><br><span class="line">              </span><br><span class="line">              	<span class="comment">// 获得实际的intent 并设置到intent字段里</span></span><br><span class="line">                Intent realIntent = intent.getParcelableExtra(Constants.EXTRA_TARGET_INTENT);</span><br><span class="line">                <span class="keyword">if</span> (realIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    intentField.set(msg.obj, realIntent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为AMS和应用之间并不传递具体的Activity信息，而是通过一个token关联，所以AMS侧仍然操作着伪造的Activity，应用侧则操作着真实的Activity，并且拥有正常的生命周期</p>
<h3 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h3><p>Java虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校检、转换解析和初始化，最终形成可以被虚拟机直接使用的Java类型，这就是虚拟机的类加载机制，是运行时动态加载的</p>
<p>Android通过DexClassLoader直接加载dex或apk</p>
<h2 id="插件Activity"><a href="#插件Activity" class="headerlink" title="插件Activity"></a>插件Activity</h2><h3 id="多ClassLoader方案"><a href="#多ClassLoader方案" class="headerlink" title="多ClassLoader方案"></a>多ClassLoader方案</h3><p>Activity的实例是在<code>ActivityThread.performLaunchActivity()</code>中创建的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo, Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ComponentName component = r.intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = r.intent.resolveActivity(mInitialApplication.getPackageManager());</span><br><span class="line">        r.intent.setComponent(component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName, r.activityInfo.targetActivity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ContextImpl appContext = createBaseContextForActivity(r);</span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class="line">      	......</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见需要拿到一个ClassLoader和类名</p>
<p>这里的<code>ClassLoader</code>是由<code>r.packageInfo</code>的<code>getClassLoader()</code>获得</p>
<p><code>r.packageInfo</code>是一个<code>LoadedApk</code>对象，代表一个当前加载了的apk的本地状态，是apk在内存中的表示</p>
<p>在<code>ActivityThread.H.handleMessage()</code>里，可以看到<code>r.pakcageInfo</code> 的来源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">    <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line">    r.packageInfo = getPackageInfoNoCheck(r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">    handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">  	<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后调用了<code>getPackageInfo()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> LoadedApk <span class="title">getPackageInfo</span><span class="params">(ApplicationInfo aInfo, CompatibilityInfo compatInfo, ClassLoader baseLoader, <span class="keyword">boolean</span> securityViolation, <span class="keyword">boolean</span> includeCode, <span class="keyword">boolean</span> registerPackage)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断调用方和自己是不是一个UserId，是的话可以共享缓存数据</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> differentUser = (UserHandle.myUserId() != UserHandle.getUserId(aInfo.uid));</span><br><span class="line">    <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">    	 WeakReference&lt;LoadedApk&gt; ref;</span><br><span class="line">        <span class="keyword">if</span> (differentUser) &#123;</span><br><span class="line">            ref = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (includeCode) &#123;</span><br><span class="line">            <span class="comment">// 调用进来传的includeCode是true 所以走这里</span></span><br><span class="line">            ref = mPackages.get(aInfo.packageName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ref = mResourcePackages.get(aInfo.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从缓存拿LoadedApk</span></span><br><span class="line">        LoadedApk packageInfo = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 未命中或者需要更新资源则创建一个</span></span><br><span class="line">   	    <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span> || (packageInfo.mResources != <span class="keyword">null</span> &amp;&amp; !packageInfo.mResources.getAssets().isUpToDate())) &#123;</span><br><span class="line">            packageInfo ＝ <span class="keyword">new</span> LoadedApk(<span class="keyword">this</span>, aInfo, compatInfo, baseLoader, securityViolation, includeCode &amp;&amp; (aInfo.flags&amp;ApplicationInfo.FLAG_HAS_CODE) != <span class="number">0</span>, registerPackage);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 系统线程和系统包的处理</span></span><br><span class="line">            <span class="keyword">if</span> (mSystemThread &amp;&amp; <span class="string">"android"</span>.equals(aInfo.packageName)) &#123;</span><br><span class="line">              packageInfo.installSystemApplicationInfo(aInfo, getSystemContext().mPackageInfo.getClassLoader());</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 缓存</span></span><br><span class="line">            <span class="keyword">if</span> (differentUser) &#123;</span><br><span class="line">          </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (includeCode) &#123;</span><br><span class="line">                mPackages.put(aInfo.packageName, <span class="keyword">new</span> WeakReference&lt;LoadedApk&gt;(packageInfo));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mResourcePackages.put(aInfo.packageName, <span class="keyword">new</span> WeakReference&lt;LoadedApk&gt;(packageInfo));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>mPackages</code> 就是一个Hook点，可以构造自己的<code>LoadedApk</code>添加进去</p>
<p><code>LoadedApk</code>又可以通过<code>getPackageInfoNoCheck()</code>获得</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> LoadedApk <span class="title">getPackageInfoNoCheck</span><span class="params">(ApplicationInfo ai, CompatibilityInfo compatInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getPackageInfo(ai, compatInfo, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要构造<code>ApplicationInfo</code>和<code>CompatibilityInfo</code>两个参数</p>
<p>前者描述了由清单的<code>application</code>标签描述的信息，可以使用<code>PackageParser</code>的<code>generateApplication()</code>方法获得，然而这个类的兼容性非常差</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationInfo <span class="title">generateApplicationInfo</span><span class="params">(Package p, <span class="keyword">int</span> flags, PackageUserState state)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<p>参数<code>Package</code>需要分析apk文件，可使用<code>PackageParser.parsePackage()</code>获得</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File packageFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">  	......</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<p>需要传入apk文件和标志位</p>
<p>后者代表不同用户中包的信息，这里用默认的即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得当前的ActivityThread对象</span></span><br><span class="line">Class&lt;?&gt; activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">Method currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">Object currentActivityThread = currentActivityThreadMethod.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得ActivityThread中的mPackages字段</span></span><br><span class="line">ArrayMap&lt;String, WeakReference&lt;Object&gt;&gt; mPackages = (ArrayMap&lt;String, WeakReference&lt;Object&gt;&gt;) ReflectUtil.getField(<span class="string">"android.app.ActivityThread"</span>, <span class="string">"mPackages"</span>, currentActivityThread);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得PackageParser.generateApplicationInfo方法</span></span><br><span class="line">Method generateApplication = ReflectUtil.getMethod(<span class="string">"android.content.pm.PackageParser"</span>, <span class="string">"generateApplicationInfo"</span>, <span class="string">"android.content.pm.PackageParser$Package"</span>, <span class="keyword">int</span>.class, <span class="string">"android.content.pm.PackageUserState"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得PackageUserState类</span></span><br><span class="line">Class&lt;?&gt; packageUserStateClass = ReflectUtil.getClass(<span class="string">"android.content.pm.PackageUserState"</span>);</span><br><span class="line">Object packageUserState = packageUserStateClass.newInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得CompatibilityInfo的DEFAULT_COMPATIBILITY_INFO字段 即默认实现</span></span><br><span class="line">Class&lt;?&gt; compatibilityInfoClass = ReflectUtil.getClass(<span class="string">"android.content.res.CompatibilityInfo"</span>);</span><br><span class="line">Object compatibilityInfo = ReflectUtil.getField(<span class="string">"android.content.res.CompatibilityInfo"</span>, <span class="string">"DEFAULT_COMPATIBILITY_INFO"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得PackageParser类 并构造一个对象</span></span><br><span class="line">Class&lt;?&gt; packageParserClass = ReflectUtil.getClass(<span class="string">"android.content.pm.PackageParser"</span>);</span><br><span class="line">Object packageParser = packageParserClass.newInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得PackageParser.parsePackage()方法并调用</span></span><br><span class="line">File apkFile = <span class="keyword">new</span> File(dstDir, <span class="string">"plugin.apk"</span>);</span><br><span class="line">Method parsePackage = ReflectUtil.getMethod(<span class="string">"android.content.pm.PackageParser"</span>, <span class="string">"parsePackage"</span>, File.class, <span class="keyword">int</span>.class);</span><br><span class="line">Object pack = parsePackage.invoke(packageParser, apkFile, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用前面拿到的方法和构造的参数得到ApplicationInfo</span></span><br><span class="line">ApplicationInfo applicationInfo = (ApplicationInfo) generateApplication.invoke(packageParser, pack, <span class="number">0</span>, packageUserState);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入插件Apk路径信息</span></span><br><span class="line">applicationInfo.sourceDir = apkFile.getPath();</span><br><span class="line">applicationInfo.publicSourceDir = apkFile.getPath();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得ActivityThread.getPackageInfoNoCheck()方法并调用得到LoadedApk</span></span><br><span class="line">Method getPackageInfoNoCheck = ReflectUtil.getMethod(<span class="string">"android.app.ActivityThread"</span>, <span class="string">"getPackageInfoNoCheck"</span>, ApplicationInfo.class, compatibilityInfoClass);</span><br><span class="line">Object loadedApk = getPackageInfoNoCheck.invoke(currentActivityThread, applicationInfo, compatibilityInfo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造一个自定义的ClassLoader</span></span><br><span class="line">String optimizedDirectory = getFilesDir() + File.separator + <span class="string">"plugin"</span>;</span><br><span class="line">File optimizedFile = <span class="keyword">new</span> File(optimizedDirectory);</span><br><span class="line"><span class="keyword">if</span> (!optimizedFile.exists()) &#123;</span><br><span class="line">    optimizedFile.mkdir();</span><br><span class="line">&#125;</span><br><span class="line">ClassLoader classLoader = <span class="keyword">new</span> HookClassLoader(apkFile.getPath(), optimizedDirectory, <span class="keyword">null</span>, <span class="keyword">this</span>.getClassLoader());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改LoadedApk的mClassLoader字段</span></span><br><span class="line">ReflectUtil.setField(<span class="string">"android.app.LoadedApk"</span>, <span class="string">"mClassLoader"</span>, classLoader, loadedApk);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 强引用保存一份 防止被回收</span></span><br><span class="line">sLoadedApk.put(applicationInfo.packageName, loadedApk);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以包名为键存放到mPackages字段中</span></span><br><span class="line">mPackages.put(applicationInfo.packageName, <span class="keyword">new</span> WeakReference&lt;&gt;(loadedApk));</span><br></pre></td></tr></table></figure>
<p>这样调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line"><span class="comment">// 填入想要调用的插件包名和类名</span></span><br><span class="line">intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">"com.example.liuhan.subproject"</span>, <span class="string">"com.example.liuhan.subproject.MainActivity"</span>));</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>按照教程这么做，后来一直找不到对应的类，堆栈中显示ClassLoader并不是我们提供的自定义ClassLoader，而<code>mPackages</code>中确实加入了插件信息</p>
<p>所以只可能是传入的键有问题，实际使用的是<code>ActivityInfo.applicationInfo.packageName</code>，通过拦截AMS回调发现这个值仍然是宿主包名，在Hook后的<code>ActivityThread.H</code> 中修改之</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拿到真实包名</span></span><br><span class="line">String packageName = realIntent.getPackage();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改一个ActivityInfo并保存起来 后用</span></span><br><span class="line">Field activityInfoField = mActivityClientRecordClass.getDeclaredField(<span class="string">"activityInfo"</span>);</span><br><span class="line">activityInfoField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">ActivityInfo activityInfo = (ActivityInfo) activityInfoField.get(msg.obj);</span><br><span class="line">activityInfo.packageName = packageName;</span><br><span class="line">activityInfo.applicationInfo.packageName = packageName;</span><br><span class="line">activityInfoField.set(msg.obj, activityInfo);</span><br></pre></td></tr></table></figure>
<p>前面也要传一下真实包名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">intent.setPackage(<span class="string">"com.example.liuhan.subproject"</span>);</span><br><span class="line">intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">"com.example.liuhan.subproject"</span>, <span class="string">"com.example.liuhan.subproject.MainActivity"</span>));</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>再次启动会遇到无法实例化Application，，追踪发现系统会向PMS查询包信息，因为没有而抛出异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!mPackageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">        initializeJavaContextClassLoader();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeJavaContextClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    IPackageManager pm = ActivityThread.getPackageManager();</span><br><span class="line">    android.content.pm.PackageInfo pi;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        pi = pm.getPackageInfo(mPackageName, PackageManager.MATCH_DEBUG_TRIAGED_MISSING, UserHandle.myUserId());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pi == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unable to get package info for "</span> + mPackageName + <span class="string">"; is package not installed?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getParentActivityName</span><span class="params">(Context context, ComponentName componentName)</span> <span class="keyword">throws</span> NameNotFoundException </span>&#123;</span><br><span class="line">    PackageManager pm = context.getPackageManager();</span><br><span class="line">    ActivityInfo info = pm.getActivityInfo(componentName, PackageManager.GET_META_DATA);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要Hook一下PMS做处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (method.getName().equals(<span class="string">"getPackageInfo"</span>)) &#123;</span><br><span class="line">    String packageName = (String) args[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (packageName.equals(<span class="string">"com.example.liuhan.subproject"</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PackageInfo();</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拦截<code>getPackageInfo()</code>命令，改为在本地查找，找到则返回，否则交给系统做，这样就骗过去了</p>
<p>最后碰到一个问题，堆栈涉及<code>AppCompatActivity</code>，把插件Activity的基类改为<code>Activity</code>就好了，尚不清楚为什么</p>
<h3 id="单ClassLoader方案"><a href="#单ClassLoader方案" class="headerlink" title="单ClassLoader方案"></a>单ClassLoader方案</h3><p>对宿主的ClassLoader做修改，使其可以找到我们插件中的类</p>
<p>在Application类中有一个成员变量<code>mLoadedApk</code>，表示宿主的LoadedApk，而这个变量是从ContextImpl中获取的；ContextImpl重写了getClassLoader方法，因此我们在Context环境中<code>getClassLoader()</code>获取到的就是宿主程序的ClassLoader</p>
<p><em>LoadedApk.java</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mClassLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            createOrUpdateClassLoaderLocked(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mClassLoader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createOrUpdateClassLoaderLocked</span><span class="params">(List&lt;String&gt; addedPaths)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mClassLoader = ApplicationLoaders.getDefault().getClassLoader(<span class="string">""</span>, mApplicationInfo.targetSdkVersion, isBundledApp, librarySearchPath, libraryPermittedPath, mBaseClassLoader);</span><br><span class="line">  	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>ApplicationLoaders.java</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ClassLoader <span class="title">getClassLoader</span><span class="params">(String zip, <span class="keyword">int</span> targetSdkVersion, <span class="keyword">boolean</span> isBundled, String librarySearchPath, String libraryPermittedPath, ClassLoader parent, String cacheKey)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    PathClassLoader pathClassloader = PathClassLoaderFactory.createClassLoader(zip, librarySearchPath, libraryPermittedPath, parent, targetSdkVersion, isBundled);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>PathClassLoader.java</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>BaseDexClassLoader.java</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    List&lt;Throwable&gt; suppressedExceptions = <span class="keyword">new</span> ArrayList&lt;Throwable&gt;();</span><br><span class="line">    Class c = pathList.findClass(name, suppressedExceptions);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ClassNotFoundException cnfe = <span class="keyword">new</span> ClassNotFoundException(<span class="string">"Didn't find class \""</span> + name + <span class="string">"\" on path: "</span> + pathList);</span><br><span class="line">        <span class="keyword">for</span> (Throwable t : suppressedExceptions) &#123;</span><br><span class="line">            cnfe.addSuppressed(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> cnfe;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到它在一个<code>pathList</code>里面查找类，是一个<code>DexPathList</code>对象</p>
<p><em>DexPathList.java</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String name, List&lt;Throwable&gt; suppressed)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">for</span> (Element element : dexElements) &#123;</span><br><span class="line">       DexFile dex = element.dexFile;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</span><br><span class="line">           Class clazz = dex.loadClassBinaryName(name, definingContext, suppressed);</span><br><span class="line">           <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> clazz;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (dexElementsSuppressedExceptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">       suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会遍历它的<code>dexElements</code>数组来查找类，可以在这里做修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得DexClassLoader的pathList字段</span></span><br><span class="line">Field pathListField = DexClassLoader.class.getSuperclass().getDeclaredField(<span class="string">"pathList"</span>);</span><br><span class="line">pathListField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Object pathList = pathListField.get(loader);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得DexList的dexElements字段</span></span><br><span class="line">Field dexElementsField = pathList.getClass().getDeclaredField(<span class="string">"dexElements"</span>);</span><br><span class="line">dexElementsField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Object[] dexElements = (Object[]) dexElementsField.get(pathList);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建新Element数组</span></span><br><span class="line">Class&lt;?&gt; elementClass = dexElements.getClass().getComponentType();</span><br><span class="line">Object[] newDexElements = (Object[]) Array.newInstance(elementClass, dexElements.length + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造插件的Element</span></span><br><span class="line">Constructor&lt;?&gt; constructor = elementClass.getConstructor(File.class, <span class="keyword">boolean</span>.class, File.class, DexFile.class);</span><br><span class="line">Object element = constructor.newInstance(apk, <span class="keyword">false</span>, apk, DexFile.loadDex(apk.getCanonicalPath(), optDex.getAbsolutePath(), <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插件Element数组</span></span><br><span class="line">Object[] toAdd = <span class="keyword">new</span> Object[] &#123; element &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将原数组和插件数组都拷贝到新数组</span></span><br><span class="line">System.arraycopy(dexElements, <span class="number">0</span>, newDexElements, <span class="number">0</span>, dexElements.length);</span><br><span class="line">System.arraycopy(toAdd, <span class="number">0</span>, newDexElements, newDexElements.length - <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置回去</span></span><br><span class="line">dexElementsField.set(pathList, newDexElements);</span><br></pre></td></tr></table></figure>
<p>多ClassLoader构架，每一个插件都有一个自己的ClassLoader，因此类的隔离性非常好——如果不同的插件使用了同一个库的不同版本，它们相安无事</p>
<p>单ClassLoader方案，插件和宿主程序的类全部都通过宿主的ClasLoader加载，虽然代码简单，但是鲁棒性很差；无法避免插件之间甚至插件与宿主之间使用的类库有冲突</p>
<p>多ClassLoader还有一个优点可以真正完成代码的热加载，如果插件需要升级，直接重新创建一个自定的ClassLoader加载新的插件，然后替换掉原来的版本即可（Java中，不同ClassLoader加载的同一个类被认为是不同的类）</p>
<p>多ClassLoader架构在大多数情况下是明智之举</p>
<h3 id="插件BroadcastReceiver"><a href="#插件BroadcastReceiver" class="headerlink" title="插件BroadcastReceiver"></a>插件BroadcastReceiver</h3><p>静态注册的接收器在清单文件里，解析后保存在PMS中，以供AMS使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List receivers = <span class="keyword">null</span>;</span><br><span class="line">List&lt;BroadcastFilter&gt; registeredReceivers = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> ((intent.getFlags()&amp;Intent.FLAG_RECEIVER_REGISTERED_ONLY) == <span class="number">0</span>) &#123;</span><br><span class="line">    receivers = collectReceiverComponents(intent, resolvedType, callingUid, users);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (intent.getComponent() == <span class="keyword">null</span>) &#123;</span><br><span class="line">    registeredReceivers = mReceiverResolver.queryIntent(intent, resolvedType, <span class="keyword">false</span>, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>receivers</code>里就是从PMS获得的静态注册的接收器，<code>registeredReceivers</code>是动态注册的接收器</p>
<h3 id="动态注册接收器"><a href="#动态注册接收器" class="headerlink" title="动态注册接收器"></a>动态注册接收器</h3><p>只需要反射即可使用</p>
<h3 id="静态注册接收器"><a href="#静态注册接收器" class="headerlink" title="静态注册接收器"></a>静态注册接收器</h3><p>分析插件清单文件中的<code>receiver</code>然后集中动态注册</p>
<blockquote>
<p>缺点是无法在应用未运行时接收到广播</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerPluginReceiver</span><span class="params">(File apkFile)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException, InvocationTargetException, ClassNotFoundException </span>&#123;</span><br><span class="line">  	<span class="comment">// 拿到PackageParser类 调用其parsePackage方法分析apk文件</span></span><br><span class="line">    Class&lt;?&gt; packageParserClass = ReflectUtil.getClass(<span class="string">"android.content.pm.PackageParser"</span>);</span><br><span class="line">    Object packageParser = packageParserClass.newInstance();</span><br><span class="line">    Method parsePackage = ReflectUtil.getMethod(<span class="string">"android.content.pm.PackageParser"</span>, <span class="string">"parsePackage"</span>, File.class, <span class="keyword">int</span>.class);</span><br><span class="line">    Object pack = parsePackage.invoke(packageParser, apkFile, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 取出Package的receivers字段</span></span><br><span class="line">    ArrayList receivers = (ArrayList) ReflectUtil.getField(<span class="string">"android.content.pm.PackageParser$Package"</span>, <span class="string">"receivers"</span>, pack);</span><br><span class="line">    <span class="keyword">for</span> (Object receiver : receivers) &#123;</span><br><span class="line">      	<span class="comment">// 取出className字段 创建一个广播接收器</span></span><br><span class="line">        String className = (String) ReflectUtil.getField(<span class="string">"android.content.pm.PackageParser$Component"</span>, <span class="string">"className"</span>, receiver);</span><br><span class="line">        Class&lt;?&gt; receiverClass = Class.forName(className);</span><br><span class="line">        BroadcastReceiver r = (BroadcastReceiver) receiverClass.newInstance();</span><br><span class="line">      </span><br><span class="line">      	<span class="comment">// 取出intents字段 里面保存的是IntentFilter 注册广播接收器</span></span><br><span class="line">        ArrayList intents = (ArrayList) ReflectUtil.getField(<span class="string">"android.content.pm.PackageParser$Component"</span>, <span class="string">"intents"</span>, receiver);</span><br><span class="line">        <span class="keyword">for</span> (Object intent : intents) &#123;</span><br><span class="line">            registerReceiver(r, (IntentFilter) intent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在插件的ClassLoader信息添加之后执行上面的方法，动态注册所有静态的广播接收器</p>
<h2 id="插件Service"><a href="#插件Service" class="headerlink" title="插件Service"></a>插件Service</h2><p>Service和Activity一样，都需要通过AMS管理，但Service不能简单的套用Activity的插件化方案，因为Activity有栈管理，有限的StubActivity可以满足需求，而Service的数量可能无法被有限的StubService满足</p>
<p>可以使用手动管理Service：拦截到<code>startService()</code>或<code>bindService()</code>，没有创建Service则创建并调用<code>onCreate</code>和<code>onStartCommand()</code>，如果创建了则调用<code>onStartCommand()</code>，拦截到<code>stopService()</code>则调用<code>onDestroy()</code></p>
<p>为了仍能使用Service的独立进程特性，可以在清单中声明一些不同进程中的Service，启动代理Service，在其<code>onStartCommand()</code>中分发执行插件Service中的<code>onStartCommand()</code>方法</p>
<h3 id="启动Service"><a href="#启动Service" class="headerlink" title="启动Service"></a>启动Service</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">".ProxyService"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>清单中定义代理Service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        ServiceManager.getInstance().onStartCommand(intent, flags, startId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理Service的<code>onStartCommand()</code>里分发到真实Service里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// 取得真实Intent</span></span><br><span class="line">    Intent realIntent = intent.getParcelableExtra(Constants.EXTRA_TARGET_INTENT);</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// 根据Intent信息找到ServiceInfo</span></span><br><span class="line">    ServiceInfo serviceInfo = selectPluginService(realIntent);</span><br><span class="line">    <span class="keyword">if</span> (serviceInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 从Service表中查找对应类名的Service</span></span><br><span class="line">    <span class="keyword">if</span> (!sServiceMap.containsKey(serviceInfo.name)) &#123;</span><br><span class="line">      	<span class="comment">// 没找到就创建</span></span><br><span class="line">        createService(intent, serviceInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    Service service = sServiceMap.get(serviceInfo.name);</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// 调用Service的onStartCommand()</span></span><br><span class="line">    service.onStartCommand(intent, flags, startId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createService</span><span class="params">(Intent intent, ServiceInfo serviceInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      	<span class="comment">// 获得CreateServiceData类 构造之</span></span><br><span class="line">        Class&lt;?&gt; createServiceDataClass = ReflectUtil.getClass(<span class="string">"android.app.ActivityThread$CreateServiceData"</span>);</span><br><span class="line">        Constructor&lt;?&gt; constructor = createServiceDataClass.getDeclaredConstructor();</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object createServiceData = constructor.newInstance();</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// 填写token/info/intent/compatInfo字段</span></span><br><span class="line">        IBinder token = <span class="keyword">new</span> Binder();</span><br><span class="line">        ReflectUtil.setField(<span class="string">"android.app.ActivityThread$CreateServiceData"</span>, <span class="string">"token"</span>, token, createServiceData);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 因为使用的单ClassLoader方案 是找不到插件对应的ClassLoader的 所以需要把其应用名改成宿主的 使用宿主ClassLoader</span></span><br><span class="line">        serviceInfo.applicationInfo.packageName = MyApplication.APP.getPackageName();</span><br><span class="line">        ReflectUtil.setField(<span class="string">"android.app.ActivityThread$CreateServiceData"</span>, <span class="string">"info"</span>, serviceInfo, createServiceData);</span><br><span class="line">        Object compatibilityInfo = ReflectUtil.getField(<span class="string">"android.content.res.CompatibilityInfo"</span>, <span class="string">"DEFAULT_COMPATIBILITY_INFO"</span>, <span class="keyword">null</span>);</span><br><span class="line">        ReflectUtil.setField(<span class="string">"android.app.ActivityThread$CreateServiceData"</span>, <span class="string">"compatInfo"</span>, compatibilityInfo, createServiceData);</span><br><span class="line">        ReflectUtil.setField(<span class="string">"android.app.ActivityThread$CreateServiceData"</span>, <span class="string">"intent"</span>, intent, createServiceData);</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// 调用ActivityThread.handleCreateService()方法</span></span><br><span class="line">        Method handleCreateService = ReflectUtil.getMethod(<span class="string">"android.app.ActivityThread"</span>, <span class="string">"handleCreateService"</span>, createServiceDataClass);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">        Method currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">        Object currentActivityThread = currentActivityThreadMethod.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        handleCreateService.invoke(currentActivityThread, createServiceData);</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// 因为创建Service方法无返回 而是把Service保存在了ActivityThread的mServices中 故取出并找到对应Service 保存在我们自己的表中</span></span><br><span class="line">        ArrayMap mServices = (ArrayMap) ReflectUtil.getField(<span class="string">"android.app.ActivityThread"</span>, <span class="string">"mServices"</span>, currentActivityThread);</span><br><span class="line">        Service service = (Service) mServices.get(token);</span><br><span class="line">        sServiceMap.put(serviceInfo.name, service);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ServiceInfo <span class="title">selectPluginService</span><span class="params">(Intent pluginIntent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (String className: sServiceInfoMap.keySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (className.equals(pluginIntent.getComponent().getClassName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> sServiceInfoMap.get(className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分发<code>onStartCommand()</code>给实际Service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (method.getName().equals(<span class="string">"startService"</span>)) &#123;</span><br><span class="line">    Intent rawIntent;</span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (args[i] <span class="keyword">instanceof</span> Intent) &#123;</span><br><span class="line">            index = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    rawIntent = (Intent) args[index];</span><br><span class="line"></span><br><span class="line">    Intent hookIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">    hookIntent.setPackage(rawIntent.getPackage());</span><br><span class="line">    ComponentName componentName = <span class="keyword">new</span> ComponentName(MyApplication.APP, ProxyService.class.getName());</span><br><span class="line">    hookIntent.setComponent(componentName);</span><br><span class="line">    hookIntent.putExtra(Constants.EXTRA_TARGET_INTENT, rawIntent);</span><br><span class="line">    args[index] = hookIntent;</span><br><span class="line">    <span class="keyword">return</span> method.invoke(mBase, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hook掉AMS，拦截<code>startService()</code>，修改Intent的目标Service为代理Service，并将真实Intent保存起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ArrayList services = (ArrayList) ReflectUtil.getField(<span class="string">"android.content.pm.PackageParser$Package"</span>, <span class="string">"services"</span>, pack);</span><br><span class="line"><span class="keyword">for</span> (Object service : services) &#123;</span><br><span class="line">    String className = (String) ReflectUtil.getField(<span class="string">"android.content.pm.PackageParser$Component"</span>, <span class="string">"className"</span>, service);</span><br><span class="line">    ServiceInfo info = (ServiceInfo) ReflectUtil.getField(<span class="string">"android.content.pm.PackageParser$Service"</span>, <span class="string">"info"</span>, service);</span><br><span class="line">    ServiceManager.sServiceInfoMap.put(className, info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析插件apk，把清单中的Service的信息保存起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">"com.example.liuhan.subproject"</span>, <span class="string">"com.example.liuhan.subproject.PluginService"</span>));</span><br><span class="line">startService(intent);</span><br></pre></td></tr></table></figure>
<p>填入包名和类名，启动Service</p>
<h3 id="绑定Service"><a href="#绑定Service" class="headerlink" title="绑定Service"></a>绑定Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">        ProxyService s = ((ProxyService.MyBinder) service).getService();</span><br><span class="line">        <span class="keyword">int</span> result = (<span class="keyword">int</span>) s.invoke(<span class="string">"com.example.liuhan.subproject.PluginService"</span>, <span class="string">"add"</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">"com.example.liuhan.subproject"</span>, <span class="string">"com.example.liuhan.subproject.PluginService"</span>));</span><br><span class="line">bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</span><br></pre></td></tr></table></figure>
<p>这里绑定了指定包名和类名的服务，在绑定成功后通过传递包名、方法名和参数调用其方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">// 因为不会调用onStartCommand() 所以在这里把实际的Intent保存起来</span></span><br><span class="line">        Intent realIntent = intent.getParcelableExtra(Constants.EXTRA_TARGET_INTENT);</span><br><span class="line">        <span class="keyword">if</span> (realIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ServiceManager.getInstance().addIntent(realIntent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBinder();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> ProxyService <span class="title">getService</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ProxyService.<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 提供一个调用函数的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(String className, String methodName, Object... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceManager.getInstance().invoke(className, methodName, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在代理服务里添加相关代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(String className, String methodName, Object... args)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// 在服务表里面查包名 没查找就创建服务</span></span><br><span class="line">    <span class="keyword">if</span> (!sServiceMap.containsKey(className)) &#123;</span><br><span class="line">        Intent intent = <span class="keyword">null</span>;</span><br><span class="line">      	<span class="comment">// 从Intent表里面查对应Intent</span></span><br><span class="line">        <span class="keyword">if</span> (sIntentMap.containsKey(className)) &#123;</span><br><span class="line">            intent = sIntentMap.get(className);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      	<span class="comment">// 根据Intent查ServiceInfo 根据ServiceInfo和Intent创建服务</span></span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ServiceInfo serviceInfo = selectPluginService(intent);</span><br><span class="line">            <span class="keyword">if</span> (serviceInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                createService(intent, serviceInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Service service = sServiceMap.get(className);</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// 获得传入参数的类信息</span></span><br><span class="line">    Class&lt;?&gt;[] argClass = <span class="keyword">new</span> Class&lt;?&gt;[args.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">        argClass[i] = args[i].getClass();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// 反射调用服务的函数</span></span><br><span class="line">    Method method = ReflectUtil.getMethod(className, methodName, argClass);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object result = method.invoke(service, args);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际服务只是一个普通的对象，反射调用其方法即可，至于跨进程的Binder机制其实由代理服务完成了，这里还是只做了一个分发而已</p>
<h2 id="插件ContentProvider"><a href="#插件ContentProvider" class="headerlink" title="插件ContentProvider"></a>插件ContentProvider</h2><p>ContentProvider的初始化在Application启动时，比<code>onCreate()</code>还要早，所以可以在<code>attachBaseContext()</code>中进行插件ContentProvider的安装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installContentProvider</span><span class="params">(File apkFile)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      	<span class="comment">// 获得PackageParser类 调用parsePackage()方法获得Package</span></span><br><span class="line">        Class&lt;?&gt; packageParserClass = ReflectUtil.getClass(<span class="string">"android.content.pm.PackageParser"</span>);</span><br><span class="line">        Object packageParser;</span><br><span class="line">        packageParser = packageParserClass.newInstance();</span><br><span class="line">        Method parsePackage = ReflectUtil.getMethod(<span class="string">"android.content.pm.PackageParser"</span>, <span class="string">"parsePackage"</span>, File.class, <span class="keyword">int</span>.class);</span><br><span class="line">        Object pack = parsePackage.invoke(packageParser, apkFile, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// 获得providers字段</span></span><br><span class="line">        ArrayList providers = (ArrayList) ReflectUtil.getField(<span class="string">"android.content.pm.PackageParser$Package"</span>, <span class="string">"providers"</span>, pack);</span><br><span class="line">        List&lt;ProviderInfo&gt; providerInfos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Object provider : providers) &#123;</span><br><span class="line">          	<span class="comment">// 获得info字段</span></span><br><span class="line">            ProviderInfo providerInfo = (ProviderInfo) ReflectUtil.getField(<span class="string">"android.content.pm.PackageParser$Provider"</span>, <span class="string">"info"</span>, provider);</span><br><span class="line">          	<span class="comment">// 需要修改这个 否则会出现安全异常 追踪代码即指导</span></span><br><span class="line">            providerInfo.applicationInfo = getApplicationInfo();</span><br><span class="line">            providerInfos.add(providerInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      	<span class="comment">// 获得ActivityThread的installContentProviders()方法</span></span><br><span class="line">      	<span class="comment">// 调用之安装插件ContentProvider</span></span><br><span class="line">        Method installContentProviders = ReflectUtil.getMethod(<span class="string">"android.app.ActivityThread"</span>, <span class="string">"installContentProviders"</span>, Context.class, List.class);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">        Method currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">        Object currentActivityThread = currentActivityThreadMethod.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        installContentProviders.invoke(currentActivityThread, <span class="keyword">this</span>, providerInfos);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>仍然可以使用分发代理的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyContentProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(@NonNull Uri uri, @Nullable String[] projection, @Nullable String selection, @Nullable String[] selectionArgs, @Nullable String sortOrder)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 构造实际的Uri</span></span><br><span class="line">      String newUri = <span class="string">"content:/"</span> + uri.getPath();</span><br><span class="line">      <span class="comment">// 实际的查询</span></span><br><span class="line">      <span class="keyword">return</span> getContext().getContentResolver().query(Uri.parse(newUri), projection, selection, selectionArgs, sortOrder);</span><br><span class="line">    &#125;</span><br><span class="line">  	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在清单中注册代理ContentProvider</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">"com.example.liuhan.plugin.ProxyContentProvider"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">".ProxyContentProvider"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="插件资源"><a href="#插件资源" class="headerlink" title="插件资源"></a>插件资源</h2><p>不做处理无法加载插件资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String apkPath = getExternalFilesDir(<span class="keyword">null</span>) + File.separator + <span class="string">"plugin"</span> + File.separator + <span class="string">"plugin.apk"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mAssetManager = AssetManager.class.newInstance();</span><br><span class="line">        Method addAssetPathMethod = mAssetManager.getClass().getDeclaredMethod(<span class="string">"addAssetPath"</span>, String.class);</span><br><span class="line">        addAssetPathMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        addAssetPathMethod.invoke(mAssetManager, apkPath);</span><br><span class="line"></span><br><span class="line">        Method ensureStringBlocks = AssetManager.class.getDeclaredMethod(<span class="string">"ensureStringBlocks"</span>);</span><br><span class="line">        ensureStringBlocks.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        ensureStringBlocks.invoke(mAssetManager);</span><br><span class="line"></span><br><span class="line">        Resources supResource = getResources();</span><br><span class="line">        mResource = <span class="keyword">new</span> Resources(mAssetManager, supResource.getDisplayMetrics(), supResource.getConfiguration());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在插件的Activity内，处理资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AssetManager <span class="title">getAssets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mAssetManager == <span class="keyword">null</span> ? <span class="keyword">super</span>.getAssets() : mAssetManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Resources <span class="title">getResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mResource == <span class="keyword">null</span> ? <span class="keyword">super</span>.getResources() : mResource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插件Activity如果继承自AppCompatActivity，主题还是有问题……</p>

      
    </div>

    <div>
      
        

      
    </div>
  
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/插件化/" rel="tag"># 插件化</a>
          
        </div>
      


    <div>
      
        

      
    </div>


    <footer class="post-footer">
         
      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/12/archivers/dlna-cling/" rel="next" title="DLNA开源库——Cling">
                <i class="fa fa-chevron-left"></i> DLNA开源库——Cling
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!--MOB SHARE BEGIN-->
<div class="-mob-share-ui-button -mob-share-open">分享</div>
<div class="-mob-share-ui" style="display: none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-tencentweibo"><p>腾讯微博</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-renren"><p>人人网</p></li>
        <li class="-mob-share-kaixin"><p>开心网</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="http://f1.webshare.mob.com/code/mob-share.js?appkey=22ad92fd0e280"></script>
<!--MOB SHARE END-->     
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="刘晗" />
          <p class="site-author-name" itemprop="name">刘晗</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#插件化"><span class="nav-number">1.</span> <span class="nav-text">插件化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代理"><span class="nav-number">1.2.</span> <span class="nav-text">代理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#静态代理"><span class="nav-number">1.2.1.</span> <span class="nav-text">静态代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态代理"><span class="nav-number">1.2.2.</span> <span class="nav-text">动态代理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hook"><span class="nav-number">1.3.</span> <span class="nav-text">Hook</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Binder-Hook"><span class="nav-number">1.4.</span> <span class="nav-text">Binder Hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS"><span class="nav-number">1.4.1.</span> <span class="nav-text">AMS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PMS"><span class="nav-number">1.4.2.</span> <span class="nav-text">PMS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity生命周期管理"><span class="nav-number">1.4.3.</span> <span class="nav-text">Activity生命周期管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ClassLoader"><span class="nav-number">1.4.4.</span> <span class="nav-text">ClassLoader</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#插件Activity"><span class="nav-number">1.5.</span> <span class="nav-text">插件Activity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多ClassLoader方案"><span class="nav-number">1.5.1.</span> <span class="nav-text">多ClassLoader方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#单ClassLoader方案"><span class="nav-number">1.5.2.</span> <span class="nav-text">单ClassLoader方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插件BroadcastReceiver"><span class="nav-number">1.5.3.</span> <span class="nav-text">插件BroadcastReceiver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态注册接收器"><span class="nav-number">1.5.4.</span> <span class="nav-text">动态注册接收器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#静态注册接收器"><span class="nav-number">1.5.5.</span> <span class="nav-text">静态注册接收器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#插件Service"><span class="nav-number">1.6.</span> <span class="nav-text">插件Service</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动Service"><span class="nav-number">1.6.1.</span> <span class="nav-text">启动Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#绑定Service"><span class="nav-number">1.6.2.</span> <span class="nav-text">绑定Service</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#插件ContentProvider"><span class="nav-number">1.7.</span> <span class="nav-text">插件ContentProvider</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#插件资源"><span class="nav-number">1.8.</span> <span class="nav-text">插件资源</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘晗</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io" rel="external nofollow">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Mist
  </a>
</div>





        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
